#
# CIP Core, generic profile
#
# Copyright (c) Siemens AG, 2020
#
# Authors:
#  Quirin Gylstorff <quirin.gylstorff@siemens.com>
#
# SPDX-License-Identifier: MIT
#
# This kas file adds efibootguard as the bootloader to the image

header:
  version: 10

local_conf_header:
  efibootguard: |
    IMAGE_INSTALL_append = " efibootguard"

  efibootguard-swupdate: |
    SWUPDATE_BOOTLOADER = "efibootguard"

  efibootguard-wic: |
    WIC_IMAGER_INSTALL_append = " efibootguard"
    WDOG_TIMEOUT ?= "60"
    WICVARS += "WDOG_TIMEOUT KERNEL_IMAGE INITRD_IMAGE DTB_FILES"
    IMAGE_FSTYPES ?= "wic"
    WKS_FILE ?= "${MACHINE}-efibootguard.wks.in"

  firmware-binaries: |
    # Add ovmf binaries for qemu
    IMAGER_BUILD_DEPS_append_qemu-amd64 += "ovmf-binaries"
    # not needed for Debian 11 and later
    OVERRIDES_append_qemu-amd64 = ":${BASE_DISTRO_CODENAME}"
    DISTRO_APT_SOURCES_append_qemu-amd64_buster = " conf/distro/debian-buster-backports.list"
    DISTRO_APT_PREFERENCES_append_qemu-amd64_buster = " conf/distro/preferences.ovmf-snakeoil.conf"
    # Add U-Boot for qemu
    IMAGER_BUILD_DEPS_append_qemu-arm64 += "u-boot-qemu-arm64"
    IMAGER_BUILD_DEPS_append_qemu-arm += "u-boot-qemu-arm"
