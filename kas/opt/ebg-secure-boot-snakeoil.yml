#
# CIP Core, generic profile
#
# Copyright (c) Siemens AG, 2020
#
# Authors:
#  Quirin Gylstorff <quirin.gylstorff@siemens.com>
#
# SPDX-License-Identifier: MIT
#

header:
  version: 10
  includes:
   - kas/opt/ebg-secure-boot-base.yml


local_conf_header:
  image-options: |
    CIP_IMAGE_OPTIONS_append = " read-only.inc"
  swupdate: |
    IMAGE_INSTALL_append = " swupdate"
    IMAGE_INSTALL_append = " swupdate-handler-roundrobin"

  verity-img: |
    SECURE_IMAGE_FSTYPE = "squashfs"
    IMAGE_FSTYPES = "secure-swupdate-img"
    WKS_FILE = "${MACHINE}-efibootguard-secureboot.wks.in"

  secure-boot: |
    # Add snakeoil and ovmf binaries for qemu
    IMAGER_BUILD_DEPS += "ebg-secure-boot-snakeoil ovmf-binaries"
    IMAGER_INSTALL += "ebg-secure-boot-snakeoil"

  ovmf: |
    # snakeoil certs are only part of backports, for Debian 11 and later the are not necessary
    OVERRIDES_append = ":${BASE_DISTRO_CODENAME}"
    DISTRO_APT_SOURCES_append_buster = " conf/distro/debian-buster-backports.list"
    DISTRO_APT_PREFERENCES_append_buster = " conf/distro/preferences.ovmf-snakeoil.conf"
